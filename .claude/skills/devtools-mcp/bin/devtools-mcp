#!/usr/bin/env bash

#
# devtools-mcp - Global CLI for Chrome DevTools MCP skill
#
# Usage: devtools-mcp <command> [options]
#

set -euo pipefail

# Script directory (resolve symlink)
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
SKILL_DIR="$(dirname "$SCRIPT_DIR")"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Functions
print_error() {
    echo -e "${RED}Error:${NC} $1" >&2
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

# Help text
show_help() {
    cat << EOF
DevTools MCP - Chrome DevTools MCP Global CLI

Usage: devtools-mcp <command> [options]

Commands:
  verify              Verify MCP setup is ready
  detect              Auto-detect project config
  url                 Build target URL from config
  browser             Detect available browsers

  dev                 Start/restart dev server
  smoke               Run smoke test (auto-starts server if needed)
  visual              Visual test - screenshots (auto-starts server)
  debug               Debug console errors (auto-starts server)
  perf                Performance trace (auto-starts server)
  a11y                Accessibility audit (auto-starts server)

  interactive         Launch Claude in interactive mode

  help                Show this help message
  version             Show version information

Options:
  --url <url>         Override URL (default: auto-detect)
  --pages <pages>     Comma-separated page paths
  --no-server         Don't start dev server (for live URLs)
  --verbose           Show detailed output

Examples:
  # Verify setup
  devtools-mcp verify

  # Start dev server
  devtools-mcp dev

  # Test local dev server (auto-detected)
  devtools-mcp smoke

  # Test live URL
  devtools-mcp smoke --url https://example.com

  # Debug console errors
  devtools-mcp debug --pages /,/about/,/contact/

  # Interactive mode
  devtools-mcp interactive

  # Performance trace
  devtools-mcp perf --url http://localhost:8000

Documentation:
  ${SKILL_DIR}/README.md
  ${SKILL_DIR}/docs/

EOF
}

# Version info
show_version() {
    cat << EOF
DevTools MCP CLI v0.1.0
Skill location: ${SKILL_DIR}
Node version: $(node --version)
EOF
}

# Verify MCP setup
cmd_verify() {
    print_info "Verifying MCP setup..."
    node "${SKILL_DIR}/lib/mcp-verify.mjs"
}

# Auto-detect project config
cmd_detect() {
    local project_path="${1:-$(pwd)}"
    print_info "Detecting project config from: ${project_path}"
    node "${SKILL_DIR}/lib/auto-detect.mjs" "$project_path"
}

# Build target URL
cmd_url() {
    local url="${1:-}"
    local project_path="$(pwd)"

    if [[ -n "$url" ]]; then
        print_info "Building URL config for: ${url}"
        node --input-type=module -e "
            import { buildTargetUrl, formatUrlConfig } from '${SKILL_DIR}/lib/url-builder.mjs';
            const config = await buildTargetUrl({ url: '${url}' });
            console.log(formatUrlConfig(config));
        "
    else
        print_info "Auto-detecting URL from project..."
        node --input-type=module -e "
            import { buildTargetUrl, formatUrlConfig } from '${SKILL_DIR}/lib/url-builder.mjs';
            const config = await buildTargetUrl();
            console.log(formatUrlConfig(config));
        "
    fi
}

# Detect browsers
cmd_browser() {
    print_info "Detecting available browsers..."
    node "${SKILL_DIR}/lib/browser-detect.mjs" all
}

# Run smoke test
cmd_smoke() {
    local url="${1:-}"

    print_info "Running smoke test..."

    # Ensure dev server is running (if testing localhost)
    ensure_dev_server "$url" || exit 1

    if [[ -n "$url" ]]; then
        claude "run smoke test on ${url}"
    else
        # Auto-detect URL
        local detected_url=$(node --input-type=module -e "
            import { buildTargetUrl } from '${SKILL_DIR}/lib/url-builder.mjs';
            try {
                const config = await buildTargetUrl();
                console.log(config.url);
            } catch (e) {
                console.error('');
            }
        " 2>/dev/null)

        if [[ -z "$detected_url" ]]; then
            print_error "Could not auto-detect URL. Specify with --url"
            exit 1
        fi

        print_info "Testing: ${detected_url}"
        claude "run smoke test on ${detected_url}"
    fi
}

# Run visual test
cmd_visual() {
    local url="${1:-}"

    print_info "Running visual test..."

    # Ensure dev server is running
    ensure_dev_server "$url" || exit 1

    if [[ -n "$url" ]]; then
        claude "screenshot ${url} at mobile, tablet, and desktop sizes"
    else
        claude "screenshot homepage at mobile, tablet, and desktop sizes"
    fi
}

# Debug console
cmd_debug() {
    local url="${1:-}"

    print_info "Debugging console errors..."

    # Ensure dev server is running
    ensure_dev_server "$url" || exit 1

    if [[ -n "$url" ]]; then
        claude "check console errors on ${url}"
    else
        claude "check console errors on homepage"
    fi
}

# Performance trace
cmd_perf() {
    local url="${1:-}"

    print_info "Running performance trace..."

    # Ensure dev server is running
    ensure_dev_server "$url" || exit 1

    if [[ -n "$url" ]]; then
        claude "measure Core Web Vitals for ${url}"
    else
        claude "measure Core Web Vitals for homepage"
    fi
}

# Accessibility audit
cmd_a11y() {
    local url="${1:-}"

    print_info "Running accessibility audit..."

    # Ensure dev server is running
    ensure_dev_server "$url" || exit 1

    if [[ -n "$url" ]]; then
        claude "check accessibility on ${url}"
    else
        claude "check accessibility on homepage"
    fi
}

# Helper: Ensure dev server is running (auto-start if needed)
ensure_dev_server() {
    local url="$1"

    # If URL provided and it's not localhost, no server needed
    if [[ -n "$url" ]] && [[ ! "$url" =~ ^https?://localhost ]] && [[ ! "$url" =~ ^https?://127\.0\.0\.1 ]]; then
        return 0
    fi

    # Detect project config
    local config=$(node --input-type=module -e "
        import { detectDevConfig } from '${SKILL_DIR}/lib/auto-detect.mjs';
        try {
            const config = await detectDevConfig();
            if (!config.detected) {
                process.exit(1);
            }
            console.log(JSON.stringify(config));
        } catch (e) {
            process.exit(1);
        }
    " 2>/dev/null)

    if [[ $? -ne 0 ]]; then
        print_warning "Could not detect dev server config"
        return 1
    fi

    local port=$(echo "$config" | jq -r '.port')
    local server_url=$(echo "$config" | jq -r '.url')

    # Check if server is already running
    if curl -s -o /dev/null -w "%{http_code}" "${server_url}" 2>/dev/null | grep -q "200\|404"; then
        print_info "Dev server already running at ${server_url}"
        return 0
    fi

    # Server not running, start it
    print_info "Dev server not running, starting automatically..."

    local start_cmd=$(echo "$config" | jq -r '.startCommand')
    local log_file=".dev-server.log"

    nohup bash -c "${start_cmd}" > "${log_file}" 2>&1 &
    local pid=$!
    echo $pid > .dev-server.pid

    print_success "Dev server started (PID: ${pid})"
    print_info "Waiting for server to be ready..."

    local max_wait=60
    local count=0

    while [[ $count -lt $max_wait ]]; do
        if curl -s -o /dev/null -w "%{http_code}" "${server_url}" 2>/dev/null | grep -q "200\|404"; then
            print_success "Server ready at ${server_url}"
            return 0
        fi
        sleep 1
        count=$((count + 1))

        if [[ $((count % 10)) -eq 0 ]]; then
            print_info "Still waiting... (${count}s)"
        fi
    done

    print_error "Server failed to start within ${max_wait} seconds"
    return 1
}

# Start/restart dev server
cmd_dev() {
    print_info "Starting dev server..."

    # Detect project config
    local config=$(node --input-type=module -e "
        import { detectDevConfig } from '${SKILL_DIR}/lib/auto-detect.mjs';
        try {
            const config = await detectDevConfig();
            if (!config.detected) {
                console.error('Could not detect dev server config');
                process.exit(1);
            }
            console.log(JSON.stringify(config));
        } catch (e) {
            console.error('Error:', e.message);
            process.exit(1);
        }
    " 2>&1)

    if [[ $? -ne 0 ]]; then
        print_error "Failed to detect project config"
        echo "$config"
        exit 1
    fi

    local framework=$(echo "$config" | jq -r '.framework')
    local port=$(echo "$config" | jq -r '.port')
    local url=$(echo "$config" | jq -r '.url')
    local start_cmd=$(echo "$config" | jq -r '.startCommand')

    print_info "Detected: ${framework} on port ${port}"

    # Check if server is already running
    if lsof -ti:${port} > /dev/null 2>&1; then
        print_warning "Port ${port} is already in use"
        read -p "Kill existing process and restart? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            print_info "Stopping existing server..."
            lsof -ti:${port} | xargs kill -9 2>/dev/null || true
            sleep 1
        else
            print_info "Server already running at ${url}"
            exit 0
        fi
    fi

    # Start dev server
    print_info "Starting server with: ${start_cmd}"

    # Run in background, redirect output to log file
    local log_file=".dev-server.log"
    nohup bash -c "${start_cmd}" > "${log_file}" 2>&1 &
    local pid=$!

    # Save PID
    echo $pid > .dev-server.pid

    print_success "Dev server started (PID: ${pid})"
    print_info "Logs: ${log_file}"

    # Wait for server to be ready
    print_info "Waiting for server to be ready..."
    local max_wait=60
    local count=0

    while [[ $count -lt $max_wait ]]; do
        if curl -s -o /dev/null -w "%{http_code}" "${url}" | grep -q "200\|404"; then
            print_success "Server is ready at ${url}"
            print_info "PID file: .dev-server.pid"
            print_info ""
            print_info "To stop: kill \$(cat .dev-server.pid)"
            print_info "To view logs: tail -f ${log_file}"
            exit 0
        fi
        sleep 1
        count=$((count + 1))

        # Show progress every 5 seconds
        if [[ $((count % 5)) -eq 0 ]]; then
            print_info "Still waiting... (${count}s)"
        fi
    done

    print_error "Server failed to start within ${max_wait} seconds"
    print_info "Check logs: tail -f ${log_file}"
    exit 1
}

# Interactive mode
cmd_interactive() {
    print_info "Launching Claude in interactive mode..."
    print_info "MCP DevTools integration active"
    echo ""

    # Check MCP is ready first
    if ! node "${SKILL_DIR}/lib/mcp-verify.mjs" > /dev/null 2>&1; then
        print_warning "MCP verification failed. Some features may not work."
        echo ""
    fi

    # Show detected config if in a project
    if [[ -f "package.json" ]]; then
        print_info "Detected project config:"
        node "${SKILL_DIR}/lib/auto-detect.mjs" 2>/dev/null || true
        echo ""
    fi

    print_info "Starting Claude CLI..."
    echo ""

    claude
}

# Parse arguments
COMMAND="${1:-help}"
shift || true

URL=""
PAGES=""
NO_SERVER=false
VERBOSE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --url)
            URL="$2"
            shift 2
            ;;
        --pages)
            PAGES="$2"
            shift 2
            ;;
        --no-server)
            NO_SERVER=true
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            print_error "Unknown option: $1"
            echo "Run 'devtools-mcp help' for usage information"
            exit 1
            ;;
    esac
done

# Execute command
case $COMMAND in
    verify)
        cmd_verify
        ;;
    detect)
        cmd_detect
        ;;
    url)
        cmd_url "$URL"
        ;;
    browser)
        cmd_browser
        ;;
    dev)
        cmd_dev
        ;;
    smoke)
        cmd_smoke "$URL"
        ;;
    visual)
        cmd_visual "$URL"
        ;;
    debug)
        cmd_debug "$URL"
        ;;
    perf)
        cmd_perf "$URL"
        ;;
    a11y)
        cmd_a11y "$URL"
        ;;
    interactive)
        cmd_interactive
        ;;
    help|--help|-h)
        show_help
        ;;
    version|--version|-v)
        show_version
        ;;
    *)
        print_error "Unknown command: $COMMAND"
        echo "Run 'devtools-mcp help' for usage information"
        exit 1
        ;;
esac
