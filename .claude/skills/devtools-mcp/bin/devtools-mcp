#!/usr/bin/env bash

#
# devtools-mcp - Global CLI for Chrome DevTools MCP skill
#
# Usage: devtools-mcp <command> [options]
#

set -euo pipefail

# Script directory (resolve symlink chain — portable across macOS and Linux)
_source="${BASH_SOURCE[0]}"
while [ -L "$_source" ]; do
    _dir="$(cd "$(dirname "$_source")" && pwd -P)"
    _source="$(readlink "$_source")"
    [[ "$_source" != /* ]] && _source="$_dir/$_source"
done
SCRIPT_DIR="$(cd "$(dirname "$_source")" && pwd -P)"
SKILL_DIR="$(dirname "$SCRIPT_DIR")"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Output helpers
print_error() { echo -e "${RED}Error:${NC} $1" >&2; }
print_success() { echo -e "${GREEN}✓${NC} $1"; }
print_info() { echo -e "${BLUE}ℹ${NC} $1"; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
print_verbose() { [[ "$VERBOSE" == true ]] && echo -e "${BLUE}  ${NC} $1" || true; }

# Dependency check
require_cmd() {
    command -v "$1" >/dev/null 2>&1 || {
        print_error "'$1' is required but not installed"
        exit 1
    }
}

require_cmd node
require_cmd jq
require_cmd curl

# Help text
show_help() {
    cat << EOF
DevTools MCP - Chrome DevTools MCP Global CLI

Usage: devtools-mcp <command> [options]

Commands:
  verify              Verify MCP setup is ready
  detect              Auto-detect project config
  url                 Build target URL from config
  browser             Detect available browsers

  dev                 Start/restart dev server
  smoke               Run smoke test (auto-starts server if needed)
  visual              Visual test - screenshots (auto-starts server)
  debug               Debug console errors (auto-starts server)
  perf                Performance trace (auto-starts server)
  a11y                Accessibility audit (auto-starts server)

  interactive         Launch Claude in interactive mode

  help                Show this help message
  version             Show version information

Options:
  --url <url>         Override URL (default: auto-detect)
  --pages <pages>     Comma-separated page paths
  --no-server         Don't start dev server (for live URLs)
  --verbose           Show detailed output

Examples:
  # Verify setup
  devtools-mcp verify

  # Start dev server
  devtools-mcp dev

  # Test local dev server (auto-detected)
  devtools-mcp smoke

  # Test live URL
  devtools-mcp smoke --url https://example.com

  # Debug console errors on specific pages
  devtools-mcp debug --pages /,/about/,/contact/

  # Smoke test without auto-starting server
  devtools-mcp smoke --url https://staging.example.com --no-server

  # Interactive mode
  devtools-mcp interactive

  # Performance trace
  devtools-mcp perf --url http://localhost:8000

Documentation:
  ${SKILL_DIR}/README.md
  ${SKILL_DIR}/docs/

EOF
}

# Version info
show_version() {
    cat << EOF
DevTools MCP CLI v0.1.0
Skill location: ${SKILL_DIR}
Node version: $(node --version)
EOF
}

# ─── Helpers ────────────────────────────────────────────────────────────────

# Safely get project dev config as JSON (stdout only, stderr suppressed)
get_dev_config() {
    local config
    if ! config=$(node "${SKILL_DIR}/lib/auto-detect.mjs" 2>/dev/null); then
        return 1
    fi
    # Validate it's JSON with a required field
    if ! echo "$config" | jq -e '.detected' >/dev/null 2>&1; then
        return 1
    fi
    echo "$config"
}

# Auto-detect target URL from project config
get_auto_url() {
    local config
    config=$(get_dev_config) || return 1
    echo "$config" | jq -r '.url // empty'
}

# Build claude prompt with optional page list
build_claude_prompt() {
    local action="$1"
    local url="${2:-}"
    local pages="${3:-}"

    local prompt="$action"

    if [[ -n "$url" ]]; then
        prompt="${prompt} on ${url}"
    else
        prompt="${prompt} on homepage"
    fi

    if [[ -n "$pages" ]]; then
        # Convert comma-separated to "on pages /, /about/, /contact/"
        prompt="${prompt} on pages ${pages}"
    fi

    echo "$prompt"
}

# Ensure dev server is running (auto-start if needed)
ensure_dev_server() {
    local url="${1:-}"

    # --no-server flag skips server management entirely
    if [[ "$NO_SERVER" == true ]]; then
        print_verbose "Skipping server management (--no-server)"
        return 0
    fi

    # If URL provided and it's not localhost, no server needed
    if [[ -n "$url" ]] && [[ ! "$url" =~ ^https?://localhost ]] && [[ ! "$url" =~ ^https?://127\.0\.0\.1 ]]; then
        print_verbose "Live URL detected, no server needed"
        return 0
    fi

    # Detect project config
    local config
    if ! config=$(get_dev_config); then
        print_warning "Could not detect dev server config"
        return 1
    fi

    local port server_url
    port=$(echo "$config" | jq -r '.port')
    server_url=$(echo "$config" | jq -r '.url')

    print_verbose "Checking server at ${server_url}"

    # Check if server is already running
    if curl -s -o /dev/null -w "%{http_code}" "${server_url}" 2>/dev/null | grep -q "200\|404"; then
        print_info "Dev server already running at ${server_url}"
        return 0
    fi

    # Server not running, start it
    print_info "Dev server not running, starting automatically..."

    local start_cmd log_file=".dev-server.log"
    start_cmd=$(echo "$config" | jq -r '.startCommand')

    nohup bash -c "${start_cmd}" > "${log_file}" 2>&1 &
    local pid=$!
    echo $pid > .dev-server.pid

    print_success "Dev server started (PID: ${pid})"
    print_info "Waiting for server to be ready..."

    local max_wait=60 count=0
    while [[ $count -lt $max_wait ]]; do
        if curl -s -o /dev/null -w "%{http_code}" "${server_url}" 2>/dev/null | grep -q "200\|404"; then
            print_success "Server ready at ${server_url}"
            return 0
        fi
        sleep 1
        count=$((count + 1))
        if [[ $((count % 10)) -eq 0 ]]; then
            print_info "Still waiting... (${count}s)"
        fi
    done

    print_error "Server failed to start within ${max_wait} seconds"
    return 1
}

# ─── Commands ───────────────────────────────────────────────────────────────

cmd_verify() {
    print_info "Verifying MCP setup..."
    node "${SKILL_DIR}/lib/mcp-verify.mjs"
}

cmd_detect() {
    local project_path="${1:-$(pwd)}"
    print_info "Detecting project config from: ${project_path}"
    node "${SKILL_DIR}/lib/auto-detect.mjs" "$project_path"
}

# Build target URL — uses env var to avoid injection
cmd_url() {
    local url="${1:-}"

    if [[ -n "$url" ]]; then
        print_info "Building URL config for: ${url}"
        DEVTOOLS_URL="$url" node --input-type=module -e "
            import { buildTargetUrl, formatUrlConfig } from '${SKILL_DIR}/lib/url-builder.mjs';
            const config = await buildTargetUrl({ url: process.env.DEVTOOLS_URL });
            console.log(formatUrlConfig(config));
        "
    else
        print_info "Auto-detecting URL from project..."
        node --input-type=module -e "
            import { buildTargetUrl, formatUrlConfig } from '${SKILL_DIR}/lib/url-builder.mjs';
            const config = await buildTargetUrl();
            console.log(formatUrlConfig(config));
        "
    fi
}

cmd_browser() {
    print_info "Detecting available browsers..."
    node "${SKILL_DIR}/lib/browser-detect.mjs" all
}

cmd_smoke() {
    local url="${1:-}"
    local pages="${2:-}"

    print_info "Running smoke test..."
    ensure_dev_server "$url" || exit 1

    if [[ -z "$url" ]]; then
        url=$(get_auto_url) || {
            print_error "Could not auto-detect URL. Specify with --url"
            exit 1
        }
    fi

    print_verbose "Target: ${url}"
    [[ -n "$pages" ]] && print_verbose "Pages: ${pages}"

    local prompt
    prompt=$(build_claude_prompt "run smoke test" "$url" "$pages")
    claude "$prompt"
}

cmd_visual() {
    local url="${1:-}"
    local pages="${2:-}"

    print_info "Running visual test..."
    ensure_dev_server "$url" || exit 1

    if [[ -z "$url" ]]; then
        url=$(get_auto_url) || {
            print_error "Could not auto-detect URL. Specify with --url"
            exit 1
        }
    fi

    print_verbose "Target: ${url}"

    local prompt
    prompt=$(build_claude_prompt "screenshot at mobile, tablet, and desktop sizes" "$url" "$pages")
    claude "$prompt"
}

cmd_debug() {
    local url="${1:-}"
    local pages="${2:-}"

    print_info "Debugging console errors..."
    ensure_dev_server "$url" || exit 1

    if [[ -z "$url" ]]; then
        url=$(get_auto_url) || {
            print_error "Could not auto-detect URL. Specify with --url"
            exit 1
        }
    fi

    print_verbose "Target: ${url}"

    local prompt
    prompt=$(build_claude_prompt "check console errors" "$url" "$pages")
    claude "$prompt"
}

cmd_perf() {
    local url="${1:-}"
    local pages="${2:-}"

    print_info "Running performance trace..."
    ensure_dev_server "$url" || exit 1

    if [[ -z "$url" ]]; then
        url=$(get_auto_url) || {
            print_error "Could not auto-detect URL. Specify with --url"
            exit 1
        }
    fi

    print_verbose "Target: ${url}"

    local prompt
    prompt=$(build_claude_prompt "measure Core Web Vitals" "$url" "$pages")
    claude "$prompt"
}

cmd_a11y() {
    local url="${1:-}"
    local pages="${2:-}"

    print_info "Running accessibility audit..."
    ensure_dev_server "$url" || exit 1

    if [[ -z "$url" ]]; then
        url=$(get_auto_url) || {
            print_error "Could not auto-detect URL. Specify with --url"
            exit 1
        }
    fi

    print_verbose "Target: ${url}"

    local prompt
    prompt=$(build_claude_prompt "check accessibility" "$url" "$pages")
    claude "$prompt"
}

cmd_dev() {
    print_info "Starting dev server..."

    # Detect project config (stderr suppressed — exit code for errors)
    local config
    if ! config=$(get_dev_config); then
        print_error "Failed to detect project config"
        print_info "Ensure package.json exists with a dev script"
        exit 1
    fi

    local framework port url start_cmd
    framework=$(echo "$config" | jq -r '.framework')
    port=$(echo "$config" | jq -r '.port')
    url=$(echo "$config" | jq -r '.url')
    start_cmd=$(echo "$config" | jq -r '.startCommand')

    print_info "Detected: ${framework} on port ${port}"
    print_verbose "Start command: ${start_cmd}"

    # Check if server is already running
    if lsof -ti:${port} > /dev/null 2>&1; then
        print_warning "Port ${port} is already in use"
        read -p "Kill existing process and restart? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            print_info "Stopping existing server..."
            lsof -ti:${port} | xargs kill -9 2>/dev/null || true
            sleep 1
        else
            print_info "Server already running at ${url}"
            exit 0
        fi
    fi

    # Start dev server
    print_info "Starting server with: ${start_cmd}"

    local log_file=".dev-server.log"
    nohup bash -c "${start_cmd}" > "${log_file}" 2>&1 &
    local pid=$!

    echo $pid > .dev-server.pid

    print_success "Dev server started (PID: ${pid})"
    print_info "Logs: ${log_file}"

    # Wait for server to be ready
    print_info "Waiting for server to be ready..."
    local max_wait=60 count=0

    while [[ $count -lt $max_wait ]]; do
        if curl -s -o /dev/null -w "%{http_code}" "${url}" | grep -q "200\|404"; then
            print_success "Server is ready at ${url}"
            print_info "PID file: .dev-server.pid"
            print_info ""
            print_info "To stop: kill \$(cat .dev-server.pid)"
            print_info "To view logs: tail -f ${log_file}"
            exit 0
        fi
        sleep 1
        count=$((count + 1))
        if [[ $((count % 5)) -eq 0 ]]; then
            print_info "Still waiting... (${count}s)"
        fi
    done

    print_error "Server failed to start within ${max_wait} seconds"
    print_info "Check logs: tail -f ${log_file}"
    exit 1
}

cmd_interactive() {
    print_info "Launching Claude in interactive mode..."
    print_info "MCP DevTools integration active"
    echo ""

    if ! node "${SKILL_DIR}/lib/mcp-verify.mjs" > /dev/null 2>&1; then
        print_warning "MCP verification failed. Some features may not work."
        echo ""
    fi

    if [[ -f "package.json" ]]; then
        print_info "Detected project config:"
        node "${SKILL_DIR}/lib/auto-detect.mjs" 2>/dev/null || true
        echo ""
    fi

    print_info "Starting Claude CLI..."
    echo ""
    claude
}

# ─── Argument Parsing ───────────────────────────────────────────────────────

COMMAND="${1:-help}"
shift || true

URL=""
PAGES=""
NO_SERVER=false
VERBOSE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --url)
            URL="$2"
            shift 2
            ;;
        --pages)
            PAGES="$2"
            shift 2
            ;;
        --no-server)
            NO_SERVER=true
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            print_error "Unknown option: $1"
            echo "Run 'devtools-mcp help' for usage information"
            exit 1
            ;;
    esac
done

# ─── Dispatch ───────────────────────────────────────────────────────────────

case $COMMAND in
    verify)
        cmd_verify
        ;;
    detect)
        cmd_detect
        ;;
    url)
        cmd_url "$URL"
        ;;
    browser)
        cmd_browser
        ;;
    dev)
        cmd_dev
        ;;
    smoke)
        cmd_smoke "$URL" "$PAGES"
        ;;
    visual)
        cmd_visual "$URL" "$PAGES"
        ;;
    debug)
        cmd_debug "$URL" "$PAGES"
        ;;
    perf)
        cmd_perf "$URL" "$PAGES"
        ;;
    a11y)
        cmd_a11y "$URL" "$PAGES"
        ;;
    interactive)
        cmd_interactive
        ;;
    help|--help|-h)
        show_help
        ;;
    version|--version|-v)
        show_version
        ;;
    *)
        print_error "Unknown command: $COMMAND"
        echo "Run 'devtools-mcp help' for usage information"
        exit 1
        ;;
esac
