#!/usr/bin/env bash

#
# devtools-mcp - Global CLI for Chrome DevTools MCP skill
#
# Usage: devtools-mcp <command> [options]
#

set -euo pipefail

# Script directory (resolve symlink chain — portable across macOS and Linux)
_source="${BASH_SOURCE[0]}"
while [ -L "$_source" ]; do
    _dir="$(cd "$(dirname "$_source")" && pwd -P)"
    _source="$(readlink "$_source")"
    [[ "$_source" != /* ]] && _source="$_dir/$_source"
done
SCRIPT_DIR="$(cd "$(dirname "$_source")" && pwd -P)"
SKILL_DIR="$(dirname "$SCRIPT_DIR")"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Output helpers
print_error() { echo -e "${RED}Error:${NC} $1" >&2; }
print_success() { echo -e "${GREEN}✓${NC} $1"; }
print_info() { echo -e "${BLUE}ℹ${NC} $1"; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
print_verbose() { [[ "$VERBOSE" == true ]] && echo -e "${BLUE}  ${NC} $1" || true; }

# Dependency check
require_cmd() {
    command -v "$1" >/dev/null 2>&1 || {
        print_error "'$1' is required but not installed"
        exit 1
    }
}

require_cmd node
require_cmd jq
require_cmd curl

# Help text
show_help() {
    cat << EOF
DevTools MCP - Chrome DevTools MCP Global CLI

Usage: devtools-mcp <command> [options]

Commands:
  verify              Verify MCP setup is ready
  detect              Auto-detect project config
  url                 Build target URL from config
  browser             Detect available browsers

  start               Start dev server (alias: dev)
  restart [grab]      Restart server, optionally with react-grab
  smoke               Run smoke test (auto-starts server if needed)
  visual              Visual test - screenshots (auto-starts server)
  debug               Debug console errors (auto-starts server)
  perf                Performance trace (auto-starts server)
  a11y                Accessibility audit (auto-starts server)

  interactive         Launch Claude in interactive mode

  help                Show this help message
  version             Show version information

Options:
  --url <url>         Override URL (default: auto-detect)
  --pages <pages>     Comma-separated page paths
  --grab              Enable react-grab MCP (React projects only)
  --no-server         Don't start dev server (for live URLs)
  --verbose           Show detailed output

Examples:
  # Verify setup
  devtools-mcp verify

  # Start dev server
  devtools-mcp start

  # Start with react-grab enabled
  devtools-mcp start --grab

  # Restart with react-grab addon
  devtools-mcp restart grab

  # Test local dev server (auto-detected)
  devtools-mcp smoke

  # Debug with react-grab component context
  devtools-mcp debug --grab

  # Test live URL
  devtools-mcp smoke --url https://example.com

  # Debug console errors on specific pages
  devtools-mcp debug --pages /,/about/,/contact/

  # Smoke test without auto-starting server
  devtools-mcp smoke --url https://staging.example.com --no-server

  # Interactive mode
  devtools-mcp interactive

  # Performance trace
  devtools-mcp perf --url http://localhost:8000

Documentation:
  ${SKILL_DIR}/README.md
  ${SKILL_DIR}/docs/

EOF
}

# Version info
show_version() {
    cat << EOF
DevTools MCP CLI v0.1.0
Skill location: ${SKILL_DIR}
Node version: $(node --version)
EOF
}

# ─── Helpers ────────────────────────────────────────────────────────────────

# Cached dev config — avoids redundant node spawns
_CACHED_CONFIG=""

# Safely get project dev config as JSON (stdout only, stderr suppressed)
# Uses cache after first successful call — saves ~150ms per avoided node spawn
get_dev_config() {
    if [[ -n "$_CACHED_CONFIG" ]]; then
        echo "$_CACHED_CONFIG"
        return 0
    fi
    local config
    if ! config=$(node "${SKILL_DIR}/lib/auto-detect.mjs" 2>/dev/null); then
        return 1
    fi
    # Validate it's JSON with a required field
    if ! echo "$config" | jq -e '.detected' >/dev/null 2>&1; then
        return 1
    fi
    _CACHED_CONFIG="$config"
    echo "$config"
}

# Auto-detect target URL from project config
get_auto_url() {
    local config
    config=$(get_dev_config) || return 1
    echo "$config" | jq -r '.url // empty'
}

# Build claude prompt with optional page list
build_claude_prompt() {
    local action="$1"
    local url="${2:-}"
    local pages="${3:-}"

    local prompt="$action"

    if [[ -n "$url" ]]; then
        prompt="${prompt} on ${url}"
    else
        prompt="${prompt} on homepage"
    fi

    if [[ -n "$pages" ]]; then
        # Convert comma-separated to "on pages /, /about/, /contact/"
        prompt="${prompt} on pages ${pages}"
    fi

    echo "$prompt"
}

# Ensure dev server is running (auto-start if needed)
ensure_dev_server() {
    local url="${1:-}"

    # --no-server flag skips server management entirely
    if [[ "$NO_SERVER" == true ]]; then
        print_verbose "Skipping server management (--no-server)"
        return 0
    fi

    # If URL provided and it's not localhost, no server needed
    if [[ -n "$url" ]] && [[ ! "$url" =~ ^https?://localhost ]] && [[ ! "$url" =~ ^https?://127\.0\.0\.1 ]]; then
        print_verbose "Live URL detected, no server needed"
        return 0
    fi

    # Detect project config
    local config
    if ! config=$(get_dev_config); then
        print_warning "Could not detect dev server config"
        return 1
    fi

    local port server_url
    port=$(echo "$config" | jq -r '.port')
    server_url=$(echo "$config" | jq -r '.url')

    print_verbose "Checking server at ${server_url}"

    # Check if server is already running
    if curl -s -o /dev/null -w "%{http_code}" "${server_url}" 2>/dev/null | grep -q "200\|404"; then
        print_info "Dev server already running at ${server_url}"
        return 0
    fi

    # Server not running, start it
    print_info "Dev server not running, starting automatically..."

    local start_cmd log_file=".dev-server.log"
    start_cmd=$(echo "$config" | jq -r '.startCommand')

    nohup bash -c "${start_cmd}" > "${log_file}" 2>&1 &
    local pid=$!
    echo $pid > .dev-server.pid

    print_success "Dev server started (PID: ${pid})"
    print_info "Waiting for server to be ready..."

    local max_wait=60 count=0
    while [[ $count -lt $max_wait ]]; do
        if curl -s -o /dev/null -w "%{http_code}" "${server_url}" 2>/dev/null | grep -q "200\|404"; then
            print_success "Server ready at ${server_url}"
            return 0
        fi
        sleep 1
        count=$((count + 1))
        if [[ $((count % 10)) -eq 0 ]]; then
            print_info "Still waiting... (${count}s)"
        fi
    done

    print_error "Server failed to start within ${max_wait} seconds"
    return 1
}

# Verify react-grab setup (exits with guidance on failure)
verify_grab_setup() {
    local config
    config=$(get_dev_config) || {
        print_error "Failed to detect project config"
        return 1
    }

    local is_react
    is_react=$(echo "$config" | jq -r '.isReact // false')

    if [[ "$is_react" != "true" ]]; then
        local framework
        framework=$(echo "$config" | jq -r '.framework // "unknown"')
        print_error "react-grab requires a React project"
        echo "  Detected framework: ${framework} (no React dependency found)"
        echo "  react-grab only works with React-based projects."
        return 1
    fi

    # Use reactGrab from cached config — no separate node spawn
    local grab_json
    grab_json=$(echo "$config" | jq '.reactGrab // {}')

    local installed script_injected mcp_configured layout_file framework_variant ready
    installed=$(echo "$grab_json" | jq -r '.installed // false')
    script_injected=$(echo "$grab_json" | jq -r '.scriptInjected // false')
    mcp_configured=$(echo "$grab_json" | jq -r '.mcpConfigured // false')
    layout_file=$(echo "$grab_json" | jq -r '.layoutFile // "layout file"')
    framework_variant=$(echo "$grab_json" | jq -r '.framework // "unknown"')
    ready=$(echo "$grab_json" | jq -r '.ready // false')

    if [[ "$ready" == "true" ]]; then
        print_success "react-grab MCP active"
        return 0
    fi

    # Not ready — give specific guidance
    if [[ "$installed" != "true" || "$script_injected" != "true" || "$mcp_configured" != "true" ]]; then

        if [[ "$installed" != "true" ]]; then
            print_error "react-grab not installed in this project"
            echo ""
            echo "  Setup (one-time):"
            echo "    npx -y grab@latest init"
            echo ""
            echo "  This will:"
            echo "    1. Add react-grab to devDependencies"
            echo "    2. Inject the grab <Script> into your layout file"
            echo "    3. Configure the MCP server"
            echo ""
            echo "  Then retry: devtools-mcp start --grab"
            return 1
        fi

        if [[ "$script_injected" != "true" ]]; then
            print_error "react-grab script not found in ${layout_file}"
            echo ""
            case "$framework_variant" in
                next-app)
                    echo "  Add to ${layout_file}:"
                    echo "    import Script from 'next/script'"
                    echo ""
                    echo "    // Inside <body>, add:"
                    echo "    <Script src=\"https://unpkg.com/react-grab\" strategy=\"afterInteractive\" />"
                    ;;
                next-pages)
                    echo "  Add to ${layout_file} <Head>:"
                    echo "    <script src=\"https://unpkg.com/react-grab\" />"
                    ;;
                vite|cra)
                    echo "  Add to ${layout_file} <head>:"
                    echo "    <script src=\"https://unpkg.com/react-grab\"></script>"
                    ;;
                gatsby)
                    echo "  Add to ${layout_file}:"
                    echo "    export const onClientEntry = () => {"
                    echo "      const script = document.createElement('script')"
                    echo "      script.src = 'https://unpkg.com/react-grab'"
                    echo "      document.head.appendChild(script)"
                    echo "    }"
                    ;;
                *)
                    echo "  Add react-grab script to your app's HTML head:"
                    echo "    <script src=\"https://unpkg.com/react-grab\"></script>"
                    ;;
            esac
            echo ""
            echo "  Or run: npx -y grab@latest init"
            return 1
        fi

        if [[ "$mcp_configured" != "true" ]]; then
            print_error "react-grab MCP server not found in Claude config"
            echo ""
            echo "  Add to MCP config:"
            echo "    npx -y grab@latest add mcp"
            echo ""
            echo "  Or manually add to ~/.config/claude-desktop/claude_desktop_config.json:"
            echo "    \"react-grab-mcp\": {"
            echo "      \"command\": \"bunx\","
            echo "      \"args\": [\"-y\", \"@react-grab/mcp\", \"--stdio\"]"
            echo "    }"
            return 1
        fi

        # Generic fallback
        print_error "react-grab not ready. Run: npx -y grab@latest init"
        return 1
    fi

    # Shouldn't reach here, but just in case
    print_error "react-grab not ready. Run: npx -y grab@latest init"
    return 1
}

# ─── Commands ───────────────────────────────────────────────────────────────

cmd_verify() {
    print_info "Verifying MCP setup..."
    local config react_flag=""
    if config=$(get_dev_config 2>/dev/null); then
        local is_react
        is_react=$(echo "$config" | jq -r '.isReact // false')
        [[ "$is_react" == "true" ]] && react_flag="--react"
    fi
    node "${SKILL_DIR}/lib/mcp-verify.mjs" $react_flag
}

cmd_detect() {
    local project_path="${1:-$(pwd)}"
    print_info "Detecting project config from: ${project_path}"
    node "${SKILL_DIR}/lib/auto-detect.mjs" "$project_path"
}

# Build target URL — uses env var to avoid injection
cmd_url() {
    local url="${1:-}"

    if [[ -n "$url" ]]; then
        print_info "Building URL config for: ${url}"
        DEVTOOLS_URL="$url" node --input-type=module -e "
            import { buildTargetUrl, formatUrlConfig } from '${SKILL_DIR}/lib/url-builder.mjs';
            const config = await buildTargetUrl({ url: process.env.DEVTOOLS_URL });
            console.log(formatUrlConfig(config));
        "
    else
        print_info "Auto-detecting URL from project..."
        node --input-type=module -e "
            import { buildTargetUrl, formatUrlConfig } from '${SKILL_DIR}/lib/url-builder.mjs';
            const config = await buildTargetUrl();
            console.log(formatUrlConfig(config));
        "
    fi
}

cmd_browser() {
    print_info "Detecting available browsers..."
    node "${SKILL_DIR}/lib/browser-detect.mjs" all
}

cmd_smoke() {
    local url="${1:-}"
    local pages="${2:-}"

    print_info "Running smoke test..."
    ensure_dev_server "$url" || exit 1

    if [[ -z "$url" ]]; then
        url=$(get_auto_url) || {
            print_error "Could not auto-detect URL. Specify with --url"
            exit 1
        }
    fi

    print_verbose "Target: ${url}"
    [[ -n "$pages" ]] && print_verbose "Pages: ${pages}"

    local prompt
    prompt=$(build_claude_prompt "run smoke test" "$url" "$pages")
    claude "$prompt"
}

cmd_visual() {
    local url="${1:-}"
    local pages="${2:-}"

    print_info "Running visual test..."
    ensure_dev_server "$url" || exit 1

    if [[ -z "$url" ]]; then
        url=$(get_auto_url) || {
            print_error "Could not auto-detect URL. Specify with --url"
            exit 1
        }
    fi

    print_verbose "Target: ${url}"

    local prompt
    prompt=$(build_claude_prompt "screenshot at mobile, tablet, and desktop sizes" "$url" "$pages")
    claude "$prompt"
}

cmd_debug() {
    local url="${1:-}"
    local pages="${2:-}"

    print_info "Debugging console errors..."
    ensure_dev_server "$url" || exit 1

    if [[ -z "$url" ]]; then
        url=$(get_auto_url) || {
            print_error "Could not auto-detect URL. Specify with --url"
            exit 1
        }
    fi

    print_verbose "Target: ${url}"

    local prompt
    prompt=$(build_claude_prompt "check console errors" "$url" "$pages")
    claude "$prompt"
}

cmd_perf() {
    local url="${1:-}"
    local pages="${2:-}"

    print_info "Running performance trace..."
    ensure_dev_server "$url" || exit 1

    if [[ -z "$url" ]]; then
        url=$(get_auto_url) || {
            print_error "Could not auto-detect URL. Specify with --url"
            exit 1
        }
    fi

    print_verbose "Target: ${url}"

    local prompt
    prompt=$(build_claude_prompt "measure Core Web Vitals" "$url" "$pages")
    claude "$prompt"
}

cmd_a11y() {
    local url="${1:-}"
    local pages="${2:-}"

    print_info "Running accessibility audit..."
    ensure_dev_server "$url" || exit 1

    if [[ -z "$url" ]]; then
        url=$(get_auto_url) || {
            print_error "Could not auto-detect URL. Specify with --url"
            exit 1
        }
    fi

    print_verbose "Target: ${url}"

    local prompt
    prompt=$(build_claude_prompt "check accessibility" "$url" "$pages")
    claude "$prompt"
}

cmd_start() {
    local grab="${1:-false}"

    print_info "Starting dev server..."

    # Detect project config (stderr suppressed — exit code for errors)
    local config
    if ! config=$(get_dev_config); then
        print_error "Failed to detect project config"
        print_info "Ensure package.json exists with a dev script"
        exit 1
    fi

    local framework port url start_cmd
    framework=$(echo "$config" | jq -r '.framework')
    port=$(echo "$config" | jq -r '.port')
    url=$(echo "$config" | jq -r '.url')
    start_cmd=$(echo "$config" | jq -r '.startCommand')

    print_info "Detected: ${framework} on port ${port}"
    print_verbose "Start command: ${start_cmd}"

    # Verify react-grab setup if requested
    if [[ "$grab" == true ]]; then
        verify_grab_setup || exit 1
    fi

    # Check if server is already running
    if lsof -ti:${port} > /dev/null 2>&1; then
        print_warning "Port ${port} is already in use"
        read -p "Kill existing process and restart? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            print_info "Stopping existing server..."
            lsof -ti:${port} | xargs kill -9 2>/dev/null || true
            sleep 1
        else
            print_info "Server already running at ${url}"
            exit 0
        fi
    fi

    # Start dev server
    print_info "Starting server with: ${start_cmd}"

    local log_file=".dev-server.log"
    nohup bash -c "${start_cmd}" > "${log_file}" 2>&1 &
    local pid=$!

    echo $pid > .dev-server.pid

    print_success "Dev server started (PID: ${pid})"
    print_info "Logs: ${log_file}"

    # Wait for server to be ready
    print_info "Waiting for server to be ready..."
    local max_wait=60 count=0

    while [[ $count -lt $max_wait ]]; do
        if curl -s -o /dev/null -w "%{http_code}" "${url}" | grep -q "200\|404"; then
            print_success "Server is ready at ${url}"
            print_info "PID file: .dev-server.pid"
            print_info ""
            print_info "To stop: kill \$(cat .dev-server.pid)"
            print_info "To view logs: tail -f ${log_file}"
            exit 0
        fi
        sleep 1
        count=$((count + 1))
        if [[ $((count % 5)) -eq 0 ]]; then
            print_info "Still waiting... (${count}s)"
        fi
    done

    print_error "Server failed to start within ${max_wait} seconds"
    print_info "Check logs: tail -f ${log_file}"
    exit 1
}

cmd_restart() {
    local addon="${1:-}"

    # Kill existing server
    if [[ -f .dev-server.pid ]]; then
        kill "$(cat .dev-server.pid)" 2>/dev/null || true
        rm -f .dev-server.pid
        print_info "Stopped existing server"
    fi

    # Enable grab mode if specified as addon
    local grab=false
    if [[ "$addon" == "grab" ]]; then
        grab=true
    fi

    cmd_start "$grab"
}

cmd_interactive() {
    print_info "Launching Claude in interactive mode..."
    print_info "MCP DevTools integration active"
    echo ""

    if ! node "${SKILL_DIR}/lib/mcp-verify.mjs" > /dev/null 2>&1; then
        print_warning "MCP verification failed. Some features may not work."
        echo ""
    fi

    if [[ -f "package.json" ]]; then
        print_info "Detected project config:"
        node "${SKILL_DIR}/lib/auto-detect.mjs" 2>/dev/null || true
        echo ""
    fi

    print_info "Starting Claude CLI..."
    echo ""
    claude
}

# ─── Argument Parsing ───────────────────────────────────────────────────────

COMMAND="${1:-help}"
shift || true

URL=""
PAGES=""
NO_SERVER=false
VERBOSE=false
GRAB_MODE=false
RESTART_ADDON=""

# For restart command, capture the addon arg before flag parsing
if [[ "$COMMAND" == "restart" ]] && [[ $# -gt 0 ]] && [[ "${1:-}" != --* ]]; then
    RESTART_ADDON="$1"
    shift
fi

while [[ $# -gt 0 ]]; do
    case $1 in
        --url)
            URL="$2"
            shift 2
            ;;
        --pages)
            PAGES="$2"
            shift 2
            ;;
        --grab)
            GRAB_MODE=true
            shift
            ;;
        --no-server)
            NO_SERVER=true
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            print_error "Unknown option: $1"
            echo "Run 'devtools-mcp help' for usage information"
            exit 1
            ;;
    esac
done

# ─── Dispatch ───────────────────────────────────────────────────────────────

# Verify grab readiness for test commands when --grab is set
if [[ "$GRAB_MODE" == true ]] && [[ "$COMMAND" =~ ^(smoke|visual|debug|perf|a11y)$ ]]; then
    verify_grab_setup || exit 1
fi

case $COMMAND in
    verify)
        cmd_verify
        ;;
    detect)
        cmd_detect
        ;;
    url)
        cmd_url "$URL"
        ;;
    browser)
        cmd_browser
        ;;
    start|dev)
        cmd_start "$GRAB_MODE"
        ;;
    restart)
        cmd_restart "$RESTART_ADDON"
        ;;
    smoke)
        cmd_smoke "$URL" "$PAGES"
        ;;
    visual)
        cmd_visual "$URL" "$PAGES"
        ;;
    debug)
        cmd_debug "$URL" "$PAGES"
        ;;
    perf)
        cmd_perf "$URL" "$PAGES"
        ;;
    a11y)
        cmd_a11y "$URL" "$PAGES"
        ;;
    interactive)
        cmd_interactive
        ;;
    help|--help|-h)
        show_help
        ;;
    version|--version|-v)
        show_version
        ;;
    *)
        print_error "Unknown command: $COMMAND"
        echo "Run 'devtools-mcp help' for usage information"
        exit 1
        ;;
esac
